@inject BlazorSignalRSample.Client.Services.SignalRService _signalRService
@inject BlazorSignalRSample.Client.Services.UserService _userService

<div class="container">
    @if (cells.Length > 0)
    {
        @if (UserAvailable) 
        {
            <div>
                <div class="clearfix">
                    <div class="@CellCssClass(cells[0])" @onclick="@(async (e) => await PlayRound(0))">@(cells[0])</div>
                    <div class="@CellCssClass(cells[1])" @onclick="@(async (e) => await PlayRound(1))">@(cells[1])</div>
                    <div class="@CellCssClass(cells[2])" @onclick="@(async (e) => await PlayRound(2))">@(cells[2])</div>
                </div>
                <div class="clearfix">
                    <div class="@CellCssClass(cells[3])" @onclick="@(async (e) => await PlayRound(3))">@(cells[3])</div>
                    <div class="@CellCssClass(cells[4])" @onclick="@(async (e) => await PlayRound(4))">@(cells[4])</div>
                    <div class="@CellCssClass(cells[5])" @onclick="@(async (e) => await PlayRound(5))">@(cells[5])</div>
                </div>
                <div class="clearfix">
                    <div class="@CellCssClass(cells[6])" @onclick="@(async (e) => await PlayRound(6))">@(cells[6])</div>
                    <div class="@CellCssClass(cells[7])" @onclick="@(async (e) => await PlayRound(7))">@(cells[7])</div>
                    <div class="@CellCssClass(cells[8])" @onclick="@(async (e) => await PlayRound(8))">@(cells[8])</div>
                </div>
            </div>
        } else {
            <p>Waiting for a user</p>
        }
    }
</div>

@if (gameover)
{
    <div class="overlay">
        <div>
            winner is @(Winner)
        </div>
        <MatButton Raised="true" @onclick="ResetGame">Reset Game</MatButton>
    </div>
}

@code {
    private string[] cells = new string[] { };
    private bool gameover = false;
    private string turn = "O";
    private bool WaitForOther = false;
    private string Winner = "";
    private bool UserAvailable = false;

    private List<string> users = new List<string>();

    protected override async Task OnInitializedAsync()
    {
        _signalRService.RoundPlayed += OtherPlayRound;
        _signalRService.ResetGame += OnResetGame;
        _userService.UserConnected += OnUserConnected;

        if (!_signalRService.IsConnected)
        {
            await _signalRService.InitConnectionAsync();
        }
        UserAvailable = await _userService.HasUsers();
        InitBoard();
    }

    public string CellCssClass(string value) {
        Console.WriteLine(value);
        return value != turn ? "cell other" : "cell";
    }

    public async Task ResetGame()
    {
        await _signalRService.ResetGameAsync();
        InitBoard();
    }

    private void InitBoard()
    {
        var result = new List<string>();
        for (var i = 0; i < 9; i++)
        {
            result.Insert(i, null);
        }
        cells = result.ToArray();
        turn = "O";
        gameover = false;
        Winner = null;
    }

    private void OnUserConnected(object sender, EventArgs data) 
    {
        UserAvailable = true;
        StateHasChanged();
    }

    private void OnResetGame(object sender, EventArgs data)
    {
        InitBoard();
        StateHasChanged();
    }

    private void OtherPlayRound(object sender, Services.GameEventArgs data)
    {
        Console.WriteLine("Other played round", data);
        if (!gameover)
        {
            if (cells[data.Value] == null)
            {
                this.cells[data.Value] = "X";
                CheckWinner();
                if (!this.gameover)
                {
                    WaitForOther = false;
                }
            }
        }
        StateHasChanged();
    }

    private async Task PlayRound(int data)
    {
        if (!gameover && !WaitForOther)
        {
            if (cells[data] == null)
            {
                this.cells[data] = turn;
                Console.WriteLine(data);
                await _signalRService.PlayRoundAsync(data);
                CheckWinner();
                if (!this.gameover)
                {
                    WaitForOther = true;
                }
            }
        }
        StateHasChanged();
    }

    private void CheckWinner()
    {
        int[][] winningOptions =
        {
            new int[] {0,1,2},
            new int[] {3,4,5},
            new int[] {6,7,8},
            new int[] {0,3,6},
            new int[] {1,4,7},
            new int[] {2,5,8},
            new int[] {0,4,8},
            new int[] {2,4,6},
        };


        foreach (var line in winningOptions)
        {
            if (cells[line[0]] == cells[line[1]] && cells[line[1]] == cells[line[2]] && cells[line[0]] != null)
            {
                gameover = true;
                Winner = cells[line[0]] == turn ? "You Win!" : "You loose!";
                return;
            }
        }

        var occupy = 0;
        foreach (var cell in cells)
        {
            occupy = occupy + (cell != null ? 1 : 0);
        }
        if (occupy == 9)
        {
            gameover = true;
            Winner = "TIE";
        }
    }

    
}